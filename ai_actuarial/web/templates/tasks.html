{% extends "base.html" %}

{% block content %}
<div class="tasks-page">
    <div class="page-header">
        <h2>Task Progress</h2>
        <p>Monitor real-time progress of collection tasks</p>
    </div>

    <div class="active-tasks">
        <h3>Active Tasks</h3>
        <div id="active-tasks-container">
            <p class="loading">Loading active tasks...</p>
        </div>
    </div>

    <div class="task-history">
        <h3>Recent Task History</h3>
        <div id="task-history-container">
            <p class="loading">Loading task history...</p>
        </div>
    </div>

    <div class="new-task">
        <h3>Start New Collection</h3>
        <div class="collection-types">
            <div class="collection-card" onclick="location.href='/collection/url'">
                <div class="card-icon">üîó</div>
                <h4>URL Collection</h4>
                <p>Collect from specific URLs</p>
            </div>
            <div class="collection-card" onclick="location.href='/collection/file'">
                <div class="card-icon">üìÅ</div>
                <h4>File Import</h4>
                <p>Import local files</p>
            </div>
            <div class="collection-card" onclick="location.href='/scheduled_tasks'">
                <div class="card-icon">üìÖ</div>
                <h4>Scheduled Collection</h4>
                <p>Run configured crawl</p>
            </div>
        </div>
    </div>
</div>

<!-- Task Detail Modal -->
<div id="log-modal" class="modal">
    <div class="modal-content large-modal">
        <span class="close" onclick="closeLogModal()">&times;</span>
        <h3>Task Details</h3>
        <pre id="log-content" class="log-viewer">Loading...</pre>
    </div>
</div>

<style>
/* Modal */
.modal {
    display: none; 
    position: fixed; 
    z-index: 1000; 
    left: 0;
    top: 0;
    width: 100%; 
    height: 100%; 
    overflow: auto; 
    background-color: rgba(0,0,0,0.4); 
}
.modal-content {
    background-color: #fefefe;
    margin: 10% auto; 
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 800px;
    border-radius: 5px;
    position: relative;
}
.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}
.close:hover {
    color: black;
}
.log-viewer {
    background: #f4f4f4;
    padding: 15px;
    border: 1px solid #ddd;
    max-height: 400px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-family: monospace;
}
</style>

<script>
let taskUpdateInterval;
let historyTasks = [];

function loadActiveTasks() {
    fetch('/api/tasks/active')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('active-tasks-container');
            if (data.tasks && data.tasks.length > 0) {
                container.innerHTML = data.tasks.map(task => `
                    <div class="task-card active-task">
                        <div class="task-header">
                            <h4>${escapeHtml(task.name)}</h4>
                            <div>
                                <span class="task-status status-${task.status}">${task.status}</span>
                                ${task.status === 'running' ? 
                                    `<button class="btn-small btn-danger" onclick="stopTask('${task.id}')" style="margin-left:10px;">Stop</button>` 
                                    : ''}
                            </div>
                        </div>
                        <div class="task-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${task.progress}%"></div>
                            </div>
                            <span class="progress-text">${task.progress}%</span>
                        </div>
                        <div class="task-details">
                            <p>Started: ${formatDate(task.started_at)}</p>
                            <p>Items: ${task.items_processed || 0} / ${task.items_total || '?'}</p>
                            ${task.current_item ? `<p class="current-item">Processing: ${escapeHtml(task.current_item)}</p>` : ''}
                        </div>
                        ${task.errors && task.errors.length > 0 ? `
                            <div class="task-errors">
                                <p class="error-count">${task.errors.length} error(s)</p>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p>No active tasks</p>';
            }
        })
        .catch(error => {
            console.error('Error loading active tasks:', error);
        });
}

function stopTask(taskId) {
    if (!confirm('Are you sure you want to stop this task?')) return;
    fetch(`/api/tasks/stop/${taskId}`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('Stop signal sent.');
                loadActiveTasks();
            } else {
                alert('Error: ' + data.error);
            }
        });
}

function loadTaskHistory() {
    fetch('/api/tasks/history?limit=10')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('task-history-container');
            if (data.tasks && data.tasks.length > 0) {
                historyTasks = data.tasks; // Store for modal lookup
                const table = document.createElement('table');
                table.className = 'tasks-table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Task</th>
                            <th>Status</th>
                            <th>Started</th>
                            <th>Completed</th>
                            <th>Items</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.tasks.map(task => `
                            <tr class="task-row status-${task.status}">
                                <td>${escapeHtml(task.name)}</td>
                                <td><span class="task-status status-${task.status}">${task.status}</span></td>
                                <td>${formatDate(task.started_at)}</td>
                                <td>${task.completed_at ? formatDate(task.completed_at) : '-'}</td>
                                <td>${task.items_processed || 0}</td>
                                <td>
                                    <button onclick="viewTaskDetails('${task.id}')" class="btn-small">Details</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                container.innerHTML = '';
                container.appendChild(table);
            } else {
                container.innerHTML = '<p>No task history</p>';
            }
        })
        .catch(error => {
            console.error('Error loading task history:', error);
        });
}

function viewTaskDetails(taskId) {
    const task = historyTasks.find(t => t.id === taskId);
    if (!task) return;
    
    const logModal = document.getElementById('log-modal');
    const logContent = document.getElementById('log-content');
    
    // Format details
    const logText = [
        `Task ID: ${task.id}`,
        `Task: ${task.name}`,
        `Type: ${task.type}`,
        `Status: ${task.status}`,
        `Started: ${task.started_at}`,
        `Completed: ${task.completed_at}`,
        `Items Processed: ${task.items_processed}`,
        `Items Downloaded: ${task.items_downloaded}`,
        '',
        '--- Errors ---',
        ...(task.errors || ['None'])
    ].join('\n');
    
    logContent.textContent = logText;
    logModal.style.display = 'block';
}

function closeLogModal() {
    document.getElementById('log-modal').style.display = 'none';
}

// Auto-refresh active tasks every 15 seconds (reduced load)
taskUpdateInterval = setInterval(loadActiveTasks, 15000);

// Load initial data
loadActiveTasks();
loadTaskHistory();

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (taskUpdateInterval) {
        clearInterval(taskUpdateInterval);
    }
});
</script>
{% endblock %}
