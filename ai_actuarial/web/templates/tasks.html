{% extends "base.html" %}

{% block content %}
<div class="tasks-page">
    <div class="page-header">
        <h2>Task Progress</h2>
        <p>Monitor real-time progress of collection tasks</p>
    </div>

    <div class="active-tasks">
        <h3>Active Tasks</h3>
        <div id="active-tasks-container">
            <p class="loading">Loading active tasks...</p>
        </div>
    </div>

    <div class="task-history">
        <h3>Recent Task History</h3>
        <div id="task-history-container">
            <p class="loading">Loading task history...</p>
        </div>
    </div>

    <div class="new-task">
        <h3>Start New Collection</h3>
        <div class="collection-types">
            <div class="collection-card" onclick="location.href='/collection/url'">
                <div class="card-icon">üîó</div>
                <h4>URL Collection</h4>
                <p>Collect from specific URLs</p>
            </div>
            <div class="collection-card" onclick="location.href='/collection/file'">
                <div class="card-icon">üìÅ</div>
                <h4>File Import</h4>
                <p>Import local files</p>
            </div>
            <div class="collection-card" onclick="location.href='/collection/scheduled'">
                <div class="card-icon">üìÖ</div>
                <h4>Scheduled Collection</h4>
                <p>Run configured crawl</p>
            </div>
        </div>
    </div>
</div>

<script>
let taskUpdateInterval;

function loadActiveTasks() {
    fetch('/api/tasks/active')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('active-tasks-container');
            if (data.tasks && data.tasks.length > 0) {
                container.innerHTML = data.tasks.map(task => `
                    <div class="task-card active-task">
                        <div class="task-header">
                            <h4>${escapeHtml(task.name)}</h4>
                            <span class="task-status status-${task.status}">${task.status}</span>
                        </div>
                        <div class="task-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${task.progress}%"></div>
                            </div>
                            <span class="progress-text">${task.progress}%</span>
                        </div>
                        <div class="task-details">
                            <p>Started: ${formatDate(task.started_at)}</p>
                            <p>Items: ${task.items_processed || 0} / ${task.items_total || '?'}</p>
                            ${task.current_item ? `<p class="current-item">Processing: ${escapeHtml(task.current_item)}</p>` : ''}
                        </div>
                        ${task.errors && task.errors.length > 0 ? `
                            <div class="task-errors">
                                <p class="error-count">${task.errors.length} error(s)</p>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p>No active tasks</p>';
            }
        })
        .catch(error => {
            console.error('Error loading active tasks:', error);
        });
}

function loadTaskHistory() {
    fetch('/api/tasks/history?limit=10')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('task-history-container');
            if (data.tasks && data.tasks.length > 0) {
                const table = document.createElement('table');
                table.className = 'tasks-table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Task</th>
                            <th>Status</th>
                            <th>Started</th>
                            <th>Completed</th>
                            <th>Items</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.tasks.map(task => `
                            <tr class="task-row status-${task.status}">
                                <td>${escapeHtml(task.name)}</td>
                                <td><span class="task-status status-${task.status}">${task.status}</span></td>
                                <td>${formatDate(task.started_at)}</td>
                                <td>${task.completed_at ? formatDate(task.completed_at) : '-'}</td>
                                <td>${task.items_processed || 0}</td>
                                <td>
                                    <button data-task-id="${escapeHtml(task.id)}" onclick="viewTaskDetails(this.dataset.taskId)" class="btn-small">Details</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                container.innerHTML = '';
                container.appendChild(table);
            } else {
                container.innerHTML = '<p>No task history</p>';
            }
        })
        .catch(error => {
            console.error('Error loading task history:', error);
        });
}

function viewTaskDetails(taskId) {
    // Navigate to the current page, preserving the path and adding/updating the task_id query parameter
    const url = new URL(window.location.href);
    url.searchParams.set('task_id', taskId);
    window.location = url.toString();
}

// Auto-refresh active tasks every 2 seconds
taskUpdateInterval = setInterval(loadActiveTasks, 2000);

// Load initial data
loadActiveTasks();
loadTaskHistory();

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (taskUpdateInterval) {
        clearInterval(taskUpdateInterval);
    }
});
</script>
{% endblock %}
