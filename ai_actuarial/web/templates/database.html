{% extends "base.html" %}

{% block content %}
<div class="database-page">
    <div class="page-header">
        <h2>Database Management</h2>
        <p>Search and manage collected files</p>
    </div>

    <div class="search-panel">
        <div class="search-bar">
            <input type="text" id="search-query" placeholder="Search by title, filename, or site..." />
            <button onclick="searchFiles()" class="btn btn-primary">Search</button>
        </div>
        <div class="filter-options">
            <select id="source-filter" onchange="searchFiles()">
                <option value="">All Sources</option>
            </select>
            <select id="category-filter" onchange="searchFiles()">
                <option value="">All Categories</option>
            </select>
            <button onclick="resetFilters()" class="btn btn-secondary" style="margin-left: auto;">Reset</button>
        </div>
    </div>

    <div class="results-panel">
        <div class="results-header">
            <h3>Files</h3>
            <div class="results-controls">
                <span id="results-count">0 files</span>
                <select id="sort-by" onchange="searchFiles()">
                    <option value="last_seen">Date (Newest First)</option>
                    <option value="oldest">Date (Oldest First)</option>
                    <option value="title">Title (A-Z)</option>
                    <option value="source_site">Source Site (A-Z)</option>
                    <option value="bytes">Size (Largest First)</option>
                </select>
            </div>
        </div>

        <div id="results-container">
            <p class="loading">Loading files...</p>
        </div>

        <div class="pagination" id="pagination">
        </div>
    </div>
</div>

<script>
let currentPage = 1;
const pageSize = 20;

// Load sources and categories for filters
fetch('/api/sources')
    .then(response => response.json())
    .then(data => {
        const select = document.getElementById('source-filter');
        data.sources.forEach(source => {
            const option = document.createElement('option');
            option.value = source;
            option.textContent = source;
            select.appendChild(option);
        });
    });

fetch('/api/categories')
    .then(response => response.json())
    .then(data => {
        const select = document.getElementById('category-filter');
        
        // Add Uncategorized option
        const optUncat = document.createElement('option');
        optUncat.value = '__uncategorized__';
        optUncat.textContent = 'Uncategorized';
        select.appendChild(optUncat);

        data.categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            select.appendChild(option);
        });
    });

function searchFiles(page = 1) {
    currentPage = page;
    const query = document.getElementById('search-query').value;
    const source = document.getElementById('source-filter').value;
    const category = document.getElementById('category-filter').value;
    let sortBy = document.getElementById('sort-by').value;
    let orderDir = 'desc'; // Default

    if (sortBy === 'oldest') {
        sortBy = 'last_seen';
        orderDir = 'asc';
    }

    const params = new URLSearchParams({
        limit: pageSize,
        offset: (page - 1) * pageSize,
        order_by: sortBy,
        order_dir: orderDir
    });

    if (query) params.append('query', query);
    if (source) params.append('source', source);
    if (category) params.append('category', category);

    document.getElementById('results-container').innerHTML = '<p class="loading">Loading...</p>';

    fetch(`/api/files?${params}`)
        .then(response => response.json())
        .then(data => {
            displayResults(data);
        })
        .catch(error => {
            console.error('Error searching files:', error);
            document.getElementById('results-container').innerHTML = '<p class="error">Error loading files</p>';
        });
}

function displayResults(data) {
    const container = document.getElementById('results-container');
    document.getElementById('results-count').textContent = `${data.total} files`;

    if (data.files && data.files.length > 0) {
        // Use Phase 3 DataTable component
        new DataTable(container, {
            data: data.files,
            columns: [
                {
                    key: 'title',
                    label: 'Title / Summary',
                    sortable: true,
                    render: (value, row) => {
                        const title = escapeHtml(row.title || row.original_filename || 'Untitled');
                        const summary = row.summary ? `<div class="file-summary">${escapeHtml(row.summary.substring(0, 100))}...</div>` : '';
                        return `<div class="file-title">${title}</div>${summary}`;
                    }
                },
                {
                    key: 'source_site',
                    label: 'Source',
                    sortable: true,
                    render: (value) => escapeHtml(value || 'Unknown')
                },
                {
                    key: 'category',
                    label: 'Category',
                    sortable: true,
                    render: (value) => escapeHtml(value || '-')
                },
                {
                    key: 'bytes',
                    label: 'Size',
                    sortable: true,
                    render: (value) => formatBytes(value)
                },
                {
                    key: 'last_seen',
                    label: 'Last Seen',
                    sortable: true,
                    render: (value) => formatDate(value)
                }
            ],
            sortable: true,
            selectable: true,
            exportable: true,
            onRowClick: (row) => {
                viewFile(row.url);
            },
            onSelectionChange: (selectedFiles) => {
                console.log(`Selected ${selectedFiles.length} files`);
            }
        });

        // Update pagination
        updatePagination(data.total);
    } else {
        container.innerHTML = '<p>No files found</p>';
        document.getElementById('pagination').innerHTML = '';
    }
}

function updatePagination(total) {
    const totalPages = Math.ceil(total / pageSize);
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }

    let html = '';
    if (currentPage > 1) {
        html += `<button onclick="searchFiles(${currentPage - 1})" class="btn-small">Previous</button>`;
    }
    
    html += `<span class="page-info">Page ${currentPage} of ${totalPages}</span>`;
    
    if (currentPage < totalPages) {
        html += `<button onclick="searchFiles(${currentPage + 1})" class="btn-small">Next</button>`;
    }
    
    pagination.innerHTML = html;
}

function resetFilters() {
    document.getElementById('search-query').value = '';
    document.getElementById('source-filter').value = '';
    document.getElementById('category-filter').value = '';
    searchFiles(1);
}

function viewFile(url) {
    window.location = `/file/${url}`;
}

function downloadFile(url) {
    // Normalize to a raw URL and ensure it is encoded exactly once in the query string.
    let rawUrl = url;
    try {
        const decoded = decodeURIComponent(url);
        // If decoding changes the value, assume the input was already encoded.
        if (decoded !== url) {
            rawUrl = decoded;
        }
    } catch (e) {
        // If decoding fails, fall back to the original value.
        rawUrl = url;
    }
    window.location = `/api/download?url=${encodeURIComponent(rawUrl)}`;
}

// Load initial results
searchFiles(1);

function debounceSearch() {
    clearTimeout(window.searchTimeout);
    window.searchTimeout = setTimeout(() => searchFiles(1), 500);
}

// Initialize Phase 3 Search Autocomplete
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-query');
    
    if (searchInput && typeof SearchAutocomplete !== 'undefined') {
        new SearchAutocomplete(searchInput, {
            onSearch: (query) => {
                searchFiles(1);
            },
            onSelect: (value) => {
                searchFiles(1);
            },
            getSuggestions: async (query) => {
                // Return search suggestions (could be enhanced with API call)
                const suggestions = [];
                
                // Add common search terms
                const commonTerms = ['PDF', 'IFRS', 'actuarial', 'insurance', 'risk'];
                commonTerms.forEach(term => {
                    if (term.toLowerCase().includes(query.toLowerCase())) {
                        suggestions.push({
                            text: term,
                            subtitle: 'Common search term'
                        });
                    }
                });
                
                return suggestions;
            },
            minLength: 2,
            debounceDelay: 300,
            showHistory: true,
            maxHistory: 5
        });
    }
});

</script>
{% endblock %}
